name: Update submodules & docs

on:
  schedule:
    - cron: "0 7 */3 * *" # every 3 days at 07:00 UTC
  workflow_dispatch:
    inputs:
      force_docs:
        description: "Force doc update even without significant changes"
        type: boolean
        default: false
      min_commits:
        description: "Minimum commits to trigger doc update (default: 5)"
        type: number
        default: 5

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      submodules_updated: ${{ steps.commit-submodules.outputs.updated }}
      docs_needed: ${{ steps.check-doc-changes.outputs.needs_update }}
      changed_submodules: ${{ steps.check-doc-changes.outputs.changed }}
      changed_manual: ${{ steps.check-doc-changes.outputs.changed_manual }}
      changed_legacy: ${{ steps.check-doc-changes.outputs.changed_legacy }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Update submodules
        run: |
          git submodule update --remote --recursive
          git status --porcelain

      - name: Commit submodule updates if needed
        id: commit-submodules
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "submodule-bot"
            git config user.email "submodule-bot@users.noreply.github.com"
            git add .
            git commit -m "chore: update submodules"
            git push
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "No submodule updates"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for significant changes needing doc updates
        id: check-doc-changes
        run: |
          MIN_COMMITS=${{ inputs.min_commits || 5 }}
          FORCE=${{ inputs.force_docs || false }}
          CHANGED_SUBMODULES=""
          CHANGED_MANUAL=""
          CHANGED_LEGACY=""

          for submodule in codex eigent gemini-cli opencode cline openhands claude-code-open; do
            if [ -d "$submodule" ]; then
              # Get last doc update time (or epoch if no doc exists)
              DOC_DIR="projects/$submodule"
              DOC_FILE="${submodule}-architecture.md"
              if [ -d "$DOC_DIR" ]; then
                LAST_DOC_UPDATE=$(git log -1 --format=%ct -- "$DOC_DIR" 2>/dev/null || echo "0")
                DOC_MODE="manual"
              elif [ -f "$DOC_FILE" ]; then
                LAST_DOC_UPDATE=$(git log -1 --format=%ct -- "$DOC_FILE" 2>/dev/null || echo "0")
                DOC_MODE="legacy"
              else
                LAST_DOC_UPDATE=0
                DOC_MODE="legacy"
                echo "No existing doc for $submodule - will generate"
              fi

              # Count commits in submodule since last doc update
              cd "$submodule"
              if [ "$LAST_DOC_UPDATE" -eq 0 ]; then
                COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "999")
              else
                COMMIT_COUNT=$(git rev-list --count --since="@$LAST_DOC_UPDATE" HEAD 2>/dev/null || echo "0")
              fi
              cd ..

              echo "$submodule: $COMMIT_COUNT commits since last doc update"

              if [ "$FORCE" = "true" ] || [ "$COMMIT_COUNT" -ge "$MIN_COMMITS" ]; then
                if [ -n "$CHANGED_SUBMODULES" ]; then
                  CHANGED_SUBMODULES="$CHANGED_SUBMODULES,$submodule"
                else
                  CHANGED_SUBMODULES="$submodule"
                fi
                if [ "$DOC_MODE" = "manual" ]; then
                  if [ -n "$CHANGED_MANUAL" ]; then
                    CHANGED_MANUAL="$CHANGED_MANUAL,$submodule"
                  else
                    CHANGED_MANUAL="$submodule"
                  fi
                else
                  if [ -n "$CHANGED_LEGACY" ]; then
                    CHANGED_LEGACY="$CHANGED_LEGACY,$submodule"
                  else
                    CHANGED_LEGACY="$submodule"
                  fi
                fi
              fi
            fi
          done

          if [ -n "$CHANGED_SUBMODULES" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "changed=$CHANGED_SUBMODULES" >> $GITHUB_OUTPUT
            echo "changed_manual=$CHANGED_MANUAL" >> $GITHUB_OUTPUT
            echo "changed_legacy=$CHANGED_LEGACY" >> $GITHUB_OUTPUT
            echo "Will update docs for: $CHANGED_SUBMODULES"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "changed=" >> $GITHUB_OUTPUT
            echo "changed_manual=" >> $GITHUB_OUTPUT
            echo "changed_legacy=" >> $GITHUB_OUTPUT
            echo "No significant changes - skipping doc generation"
          fi

  generate-docs:
    needs: update
    if: needs.update.outputs.docs_needed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          ref: main # Get latest after submodule update

      - name: Pull latest changes
        run: git pull origin main

      - name: Generate architecture docs
        if: needs.update.outputs.changed_legacy != ''
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            The following submodules have significant updates and need their legacy architecture docs updated incrementally: ${{ needs.update.outputs.changed_legacy }}

            For each submodule listed above:
            1. Read the doc-gen prompt template from .prompts/doc-gen.md
            2. Analyze the submodule directory thoroughly
            3. Update the {submodule-name}-architecture.md file in the repo root
            4. If a doc already exists, do NOT regenerate from scratch; patch only the sections affected by recent changes or missing details
            5. Use git log/diff in the submodule to scope the edits and preserve the existing structure and wording where still accurate

            Focus on the agentic patterns: sessions, tools, context management, orchestration.
            Include mermaid diagrams for system maps, message flows, and tool lifecycles.
          allowed_tools: "Bash(git log:*),Bash(git diff:*),Bash(ls:*),Bash(find:*),Read,Write,Edit,Glob,Grep"

      - name: Generate manual architecture docs
        if: needs.update.outputs.changed_manual != ''
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            The following submodules have significant updates and use the manual doc structure under projects/<submodule>/: ${{ needs.update.outputs.changed_manual }}

            For each submodule listed above:
            1. Read the doc-gen manual prompt template from .prompts/doc-gen-manual.md
            2. Analyze the submodule directory thoroughly
            3. Update the docs inside projects/<submodule>/ (do not create {submodule}-architecture.md)
            4. If docs already exist, do NOT regenerate from scratch; patch only the sections affected by recent changes or missing details
            5. Use git log/diff in the submodule to scope the edits and preserve the existing structure and wording where still accurate

            Focus on the agentic patterns: sessions, tools, context management, orchestration.
            Update diagrams only when the underlying flow changed.
          allowed_tools: "Bash(git log:*),Bash(git diff:*),Bash(ls:*),Bash(find:*),Read,Write,Edit,Glob,Grep"

      - name: Commit and push doc updates
        run: |
          if [ -n "$(git status --porcelain -- 'projects/*' '*-architecture.md')" ]; then
            git config user.name "doc-bot"
            git config user.email "doc-bot@users.noreply.github.com"
            MANUAL="${{ needs.update.outputs.changed_manual }}"
            LEGACY="${{ needs.update.outputs.changed_legacy }}"

            if [ -n "$MANUAL" ]; then
              IFS=',' read -ra SUBS <<< "$MANUAL"
              for s in "${SUBS[@]}"; do
                git add "projects/$s"
              done
            fi

            if [ -n "$LEGACY" ]; then
              IFS=',' read -ra SUBS <<< "$LEGACY"
              for s in "${SUBS[@]}"; do
                git add "${s}-architecture.md"
              done
            fi

            {
              echo "docs: auto-update architecture docs"
              echo
              if [ -n "$MANUAL" ]; then
                echo "Updated manual docs for: $MANUAL"
              fi
              if [ -n "$LEGACY" ]; then
                echo "Updated legacy docs for: $LEGACY"
              fi
              echo
              echo "Generated by Claude Code from .prompts/doc-gen.md and .prompts/doc-gen-manual.md"
            } > /tmp/commitmsg
            git commit -F /tmp/commitmsg
            git push
            echo "âœ… Architecture docs updated and pushed"
          else
            echo "No doc changes to commit"
          fi
